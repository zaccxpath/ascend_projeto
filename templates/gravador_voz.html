<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <title>ASCEND - Gravador de Voz Disruptivo</title>
    <style>
        /* Estilo para a contagem regressiva */
        .countdown {
            font-size: 5rem;
            font-weight: bold;
            text-align: center;
            color: #007bff;
            margin: 15px 0;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Estilo para as ondas de √°udio */
        .audio-waves {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            height: 60px;
            margin: 20px 0;
        }
        
        .wave {
            width: 10px;
            height: 40px;
            background-color: #3498db;
            border-radius: 5px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .wave:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .wave:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        .wave:nth-child(4) {
            animation-delay: 0.3s;
        }
        
        .wave:nth-child(5) {
            animation-delay: 0.4s;
        }
        
        @keyframes wave {
            0%, 100% {
                height: 20px;
            }
            50% {
                height: 60px;
            }
        }
        
        /* Estilo para o container de contagem regressiva */
        #countdown-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        #countdown {
            font-size: 10rem;
            color: white;
            text-shadow: 0 0 20px rgba(52, 152, 219, 0.8);
        }
        
        /* Estilo para o bot√£o de grava√ß√£o */
        #recordButton {
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        #recordButton:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Estilo para o display de tempo */
        #time-display {
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        /* Estilo para o resultado */
        #result {
            min-height: 100px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <header>
        <h1>PROJETO ASCEND</h1>
        <p>Gravador de Voz com An√°lise de Sentimentos</p>
    </header>

    <div class="container">
        <!-- Atualiza√ß√£o na navega√ß√£o: adicionando "Feedback Detalhado" -->
        <nav class="mb-4">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="/"><i class="fas fa-microphone"></i> Gravador</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/historico"><i class="fas fa-history"></i> Hist√≥rico</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard"><i class="fas fa-chart-bar"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/adicionar"><i class="fas fa-plus"></i> Adicionar Feedback</a>
                </li>
                <!-- Novo item de menu para o feedback detalhado -->
                <li class="nav-item">
                    <a class="nav-link" href="/feedback"><i class="fas fa-edit"></i> Feedback Detalhado</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/relatorio-ponderado">An√°lise Ponderada</a>
                </li>
            </ul>
        </nav>

        <div class="container-fluid">
            <div class="row justify-content-center py-5">
                <div class="col-md-8 text-center">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4>Gravador de Voz para An√°lise de Sentimento</h4>
                        </div>
                        <div class="card-body">
                            <p id="status">Clique no bot√£o para iniciar a grava√ß√£o</p>
                            
                            <!-- Barra de progresso do tempo -->
                            <div id="progress-container" style="display: none;">
                                <div class="progress mb-3">
                                    <div id="recording-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <p id="time-display" class="small text-muted">0s / 30s</p>
                            </div>
                            
                            <div class="audio-waves" id="audio-waves" style="display: none;">
                                <div class="wave"></div>
                                <div class="wave"></div>
                                <div class="wave"></div>
                                <div class="wave"></div>
                                <div class="wave"></div>
                            </div>
                            <div id="countdown-container" style="display: none;">
                                <h1 id="countdown" class="display-1">3</h1>
                            </div>
                            <button id="recordButton" class="btn btn-primary btn-lg mt-3" onclick="iniciarContagem()">
                                <i class="fas fa-microphone"></i> Clique para Gravar
                            </button>
                            <div class="mt-4">
                                <h5>Sua mensagem:</h5>
                                <div id="result" class="p-3 border rounded text-start">
                                    Sua transcri√ß√£o aparecer√° aqui...
                                </div>
                            </div>
                            <div id="sentiment-container" class="mt-4 d-none">
                                <h5>An√°lise de Sentimento:</h5>
                                <div id="sentiment-card" class="card">
                                    <div class="card-body">
                                        <h5 id="sentiment-text" class="card-title">Neutro</h5>
                                        <div id="sentiment-emoji" class="display-1 text-center">üòê</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="/historico" class="btn btn-outline-secondary btn-block">
                                        <i class="fas fa-history"></i> Ver Hist√≥rico
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="/dashboard" class="btn btn-outline-info btn-block">
                                        <i class="fas fa-chart-bar"></i> Ver Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <h3>Sobre o Projeto ASCEND</h3>
            <p>
                O projeto ASCEND transforma voz em insights valiosos atrav√©s de an√°lise de sentimentos.
                Ideal para coletar feedback de clientes e melhorar a experi√™ncia de compra!
            </p>
            <div class="features">
                <div class="feature">
                    <i class="fas fa-microphone-alt"></i>
                    <span>Grava√ß√£o por Voz</span>
                </div>
                <div class="feature">
                    <i class="fas fa-chart-line"></i>
                    <span>An√°lise de Sentimentos</span>
                </div>
                <div class="feature">
                    <i class="fas fa-lightbulb"></i>
                    <span>Insights Acion√°veis</span>
                </div>
            </div>
        </div>

        {% if not modelo_xlm_roberta %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <strong>Aviso!</strong> O modelo avan√ßado XLM-RoBERTa n√£o est√° dispon√≠vel. Estamos usando um modelo b√°sico para an√°lise de sentimento.
          <a href="/diagnostico" class="alert-link">Visite a p√°gina de diagn√≥stico</a> para mais informa√ß√µes e op√ß√µes para resolver este problema.
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endif %}
    </div>

    <footer>
        <p>ASCEND - An√°lise de Sentimentos Cognitiva para Experi√™ncia do Cliente | Projeto Disruptivo</p>
    </footer>

    <script>
        // Fun√ß√£o para controlar a anima√ß√£o de ondas de √°udio
        function toggleWaveAnimation(show) {
            const wavesContainer = document.getElementById('audio-waves');
            if (show) {
                wavesContainer.style.display = 'flex';
            } else {
                wavesContainer.style.display = 'none';
            }
        }

        // Fun√ß√£o para mostrar o resultado do sentimento
        function mostrarSentimento(sentimento, compound) {
            const sentimentContainer = document.getElementById('sentiment-container');
            const sentimentText = document.getElementById('sentiment-text');
            const sentimentEmoji = document.getElementById('sentiment-emoji');
            
            sentimentContainer.classList.remove('d-none');
            
            // Definir cor e emoji com base no sentimento
            let emoji = 'üòê';
            let bgColor = 'bg-secondary';
            let textColor = 'text-white';
            
            if (sentimento === 'positivo') {
                emoji = 'üòÑ';
                bgColor = 'bg-success';
            } else if (sentimento === 'negativo') {
                emoji = 'üòû';
                bgColor = 'bg-danger';
            } else {
                emoji = 'üòê';
                bgColor = 'bg-secondary';
            }
            
            // Exibir o resultado
            sentimentText.innerText = sentimento.charAt(0).toUpperCase() + sentimento.slice(1);
            sentimentEmoji.innerText = emoji;
            
            // Aplicar cores
            const card = document.getElementById('sentiment-card');
            card.className = 'card ' + bgColor + ' ' + textColor;
        }

        // Verificar permiss√£o do microfone
        async function checkMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Fechar stream ap√≥s obter permiss√£o
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Erro ao obter permiss√£o do microfone:', error);
                return false;
            }
        }

        // Nova fun√ß√£o para iniciar a contagem regressiva
        async function iniciarContagem() {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('status');
            const countdownContainer = document.getElementById('countdown-container');
            const countdownElement = document.getElementById('countdown');
            
            // Verificar permiss√£o do microfone
            const hasMicPermission = await checkMicrophonePermission();
            if (!hasMicPermission) {
                status.innerText = 'Erro: Permiss√£o para microfone negada!';
                document.getElementById('result').innerText = 'Por favor, permita o acesso ao microfone no seu navegador e tente novamente.';
                return;
            }
            
            // Desabilitar o bot√£o durante a contagem
            button.disabled = true;
            status.innerText = 'Preparando para gravar...';
            
            // Mostrar o elemento de contagem
            countdownContainer.style.display = 'block';
            
            // Contagem regressiva de 3 a 1
            for (let i = 3; i > 0; i--) {
                countdownElement.innerText = i;
                countdownElement.classList.add('animate__animated', 'animate__bounceIn');
                
                // Esperar 1 segundo
                await new Promise(resolve => setTimeout(resolve, 1000));
                countdownElement.classList.remove('animate__animated', 'animate__bounceIn');
            }
            
            // Mostrar "Pronto!"
            countdownElement.innerText = "Pronto!";
            countdownElement.classList.add('animate__animated', 'animate__zoomIn');
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Esconder o elemento de contagem regressiva
            countdownContainer.style.display = 'none';
            countdownElement.classList.remove('animate__animated', 'animate__zoomIn');
            
            // Iniciar a grava√ß√£o
            ouvirMicrofone();
        }

        // Fun√ß√£o para ouvir o microfone
        let activeRecordingRequest = null; // Vari√°vel para armazenar a requisi√ß√£o ativa

        function ouvirMicrofone() {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('status');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('recording-progress');
            const timeDisplay = document.getElementById('time-display');
            
            // Criar o bot√£o de parar grava√ß√£o
            button.innerHTML = '<i class="fas fa-stop"></i> Parar Grava√ß√£o';
            button.classList.remove('btn-primary');
            button.classList.add('btn-danger');
            
            // Mudar a fun√ß√£o do bot√£o para parar a grava√ß√£o
            button.onclick = pararGravacao;
            
            status.innerText = 'Estamos ouvindo a sua voz... (fale claramente)';
            
            const sentimentContainer = document.getElementById('sentiment-container');
            sentimentContainer.classList.add('d-none');
            
            // Mostrar a barra de progresso
            progressContainer.style.display = 'block';
            
            toggleWaveAnimation(true);
            
            // Tempo m√°ximo de grava√ß√£o em segundos
            const maxDuration = 30;
            // Limite para mostrar aviso de tempo
            const warningThreshold = 25;
            
            let timeElapsed = 0;
            let silentTime = 0;
            let isSilent = false;
            
            const timerInterval = setInterval(() => {
                timeElapsed += 1;
                
                // Atualizar a barra de progresso
                const progressPercent = (timeElapsed / maxDuration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                // Se estiver detectando sil√™ncio
                if (isSilent) {
                    silentTime += 1;
                    timeDisplay.innerHTML = `${timeElapsed}s / ${maxDuration}s <span class="badge badge-warning">Sil√™ncio detectado: ${silentTime}s</span>`;
                    
                    // Piscar a mensagem de sil√™ncio
                    if (silentTime % 2 === 0) {
                        status.classList.add('text-warning');
                    } else {
                        status.classList.remove('text-warning');
                    }
                } else {
                    timeDisplay.innerText = `${timeElapsed}s / ${maxDuration}s`;
                }
                
                // Mudar a cor da barra de progresso quando estiver chegando ao limite
                if (timeElapsed >= warningThreshold) {
                    progressBar.classList.remove('bg-primary', 'bg-warning');
                    progressBar.classList.add('bg-danger');
                    status.innerText = `ATEN√á√ÉO: Restam apenas ${maxDuration - timeElapsed} segundos!`;
                    status.classList.add('text-danger', 'font-weight-bold');
                } else if (timeElapsed >= 15) {
                    progressBar.classList.remove('bg-primary');
                    progressBar.classList.add('bg-warning');
                    status.innerText = 'Continue falando... (grava√ß√£o em andamento)';
                } else {
                    status.innerText = `Estamos ouvindo sua voz... (${timeElapsed}s)`;
                }
            }, 1000);
            
            // Controlar sil√™ncio - simula√ß√£o do comportamento do backend
            // Criar um analisador de √°udio para detectar sil√™ncio
            let silenceDetectionInterval;
            
            try {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const analyser = audioContext.createAnalyser();
                        const microphone = audioContext.createMediaStreamSource(stream);
                        const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                        
                        analyser.smoothingTimeConstant = 0.8;
                        analyser.fftSize = 1024;
                        
                        microphone.connect(analyser);
                        analyser.connect(scriptProcessor);
                        scriptProcessor.connect(audioContext.destination);
                        
                        const silenceThreshold = 10;
                        scriptProcessor.onaudioprocess = function() {
                            const array = new Uint8Array(analyser.frequencyBinCount);
                            analyser.getByteFrequencyData(array);
                            const arraySum = array.reduce((a, value) => a + value, 0);
                            const average = arraySum / array.length;
                            
                            // Se o volume m√©dio estiver abaixo do limiar, consideramos como sil√™ncio
                            if (average < silenceThreshold) {
                                if (!isSilent) {
                                    isSilent = true;
                                    status.innerText = "Sil√™ncio detectado... (continuando a grava√ß√£o)";
                                    status.classList.add('text-warning');
                                }
                            } else {
                                if (isSilent) {
                                    isSilent = false;
                                    silentTime = 0;
                                    status.classList.remove('text-warning');
                                    status.innerText = `Estamos ouvindo sua voz... (${timeElapsed}s)`;
                                }
                            }
                        };
                        
                        // Armazenar as conex√µes para limpar depois
                        silenceDetectionInterval = {
                            stop: function() {
                                stream.getTracks().forEach(track => track.stop());
                                scriptProcessor.disconnect();
                                analyser.disconnect();
                                microphone.disconnect();
                                if (audioContext.state !== 'closed') {
                                    audioContext.close();
                                }
                            }
                        };
                    })
                    .catch(error => {
                        console.error("Erro ao acessar microfone para detec√ß√£o de sil√™ncio:", error);
                    });
            } catch (error) {
                console.error("Erro ao configurar detec√ß√£o de sil√™ncio:", error);
            }
            
            activeRecordingRequest = fetch('/ouvir', { 
                method: 'POST',
                signal: AbortSignal.timeout(32000) // Um pouco mais que o tempo m√°ximo
            })
                .then(response => response.json())
                .then(data => {
                    clearInterval(timerInterval);
                    if (silenceDetectionInterval) {
                        silenceDetectionInterval.stop();
                    }
                    
                    resetarBotaoGravacao();
                    
                    // Mostrar mensagem com base no motivo de parada
                    if (data.success) {
                        if (data.motivo_parada === 'silencio_detectado') {
                            status.innerText = 'Grava√ß√£o conclu√≠da! (Detectamos sil√™ncio)';
                        } else if (data.motivo_parada === 'sem_fala') {
                            status.innerText = 'N√£o conseguimos ouvir sua voz. Tente falar mais alto!';
                        } else {
                            status.innerText = 'Grava√ß√£o conclu√≠da!';
                        }
                    } else {
                        status.innerText = 'Erro ao gravar!';
                    }
                    
                    status.classList.remove('text-danger', 'font-weight-bold', 'text-warning');
                    document.getElementById('result').innerText = data.texto;
                    
                    // Esconder a barra de progresso
                    progressContainer.style.display = 'none';
                    
                    if (data.sentimento) {
                        mostrarSentimento(data.sentimento, data.compound);
                    }
                    
                    toggleWaveAnimation(false);
                    
                    // Limpar a requisi√ß√£o ativa
                    activeRecordingRequest = null;
                })
                .catch(error => {
                    clearInterval(timerInterval);
                    if (silenceDetectionInterval) {
                        silenceDetectionInterval.stop();
                    }
                    
                    resetarBotaoGravacao();
                    
                    status.innerText = 'Erro ao gravar.';
                    status.classList.remove('text-danger', 'font-weight-bold', 'text-warning');
                    document.getElementById('result').innerText = 'Erro ao gravar: ' + error;
                    
                    // Esconder a barra de progresso
                    progressContainer.style.display = 'none';
                    
                    toggleWaveAnimation(false);
                    
                    // Limpar a requisi√ß√£o ativa
                    activeRecordingRequest = null;
                });
        }
        
        // Fun√ß√£o para parar a grava√ß√£o manualmente
        function pararGravacao() {
            // Se n√£o houver uma grava√ß√£o ativa, n√£o fazer nada
            if (!activeRecordingRequest) return;
            
            const status = document.getElementById('status');
            status.innerText = 'Finalizando grava√ß√£o...';
            
            // Abortar a requisi√ß√£o atual (se suportado pelo navegador)
            if (window.AbortController && activeRecordingRequest.controller) {
                activeRecordingRequest.controller.abort();
            }
            
            // Resetar o bot√£o
            resetarBotaoGravacao();
            
            // Iniciar nova requisi√ß√£o para finalizar a grava√ß√£o
            fetch('/ouvir', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ manual_stop: true })
            })
            .then(response => response.json())
            .then(data => {
                status.innerText = 'Grava√ß√£o finalizada manualmente!';
                document.getElementById('result').innerText = data.texto || 'Transcri√ß√£o n√£o dispon√≠vel';
                
                if (data.sentimento) {
                    mostrarSentimento(data.sentimento, data.compound);
                }
                
                // Esconder a barra de progresso
                document.getElementById('progress-container').style.display = 'none';
                toggleWaveAnimation(false);
            })
            .catch(error => {
                status.innerText = 'Erro ao finalizar grava√ß√£o.';
                document.getElementById('result').innerText = 'Erro ao finalizar: ' + error;
                
                // Esconder a barra de progresso
                document.getElementById('progress-container').style.display = 'none';
                toggleWaveAnimation(false);
            });
        }
        
        // Fun√ß√£o para resetar o bot√£o de grava√ß√£o
        function resetarBotaoGravacao() {
            const button = document.getElementById('recordButton');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-microphone"></i> Clique para Gravar';
            button.classList.remove('btn-danger');
            button.classList.add('btn-primary');
            button.onclick = iniciarContagem;
        }
    </script>
</body>
</html>